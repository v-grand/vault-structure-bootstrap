# N8N and Vault Integration Guide

This guide explains how to configure your n8n instance to securely fetch credentials from HashiCorp Vault using the AppRole authentication method.

## Prerequisites

1.  The Vault structure module has been applied (`make apply`).
2.  You have access to the Vault server (`VAULT_ADDR`) and a token with sufficient permissions to generate a `SecretID`.

## Authentication Flow

We use Vault's AppRole method, which provides a secure, automated way for machines to authenticate. Your n8n container will need two pieces of information:

-   `ROLE_ID`: A non-secret identifier for the role it assumes (e.g., `n8n-prod-role`).
-   `SECRET_ID`: A secret credential, similar to a password, that is used to log in.

## Configuration Steps

### Step 1: Get the Role ID

The `RoleID` is generated by Terraform. You can retrieve it from the Terraform output after applying the configuration.

Run the following command and find the `role_id` for your target environment (e.g., `n8n_prod_role`):

```bash
terraform -chdir=terraform/vault-structure output n8n_approle_info
```

### Step 2: Generate a Secret ID

The `SecretID` is a secret and should be generated just before you start your n8n container. It is short-lived and can only be used once.

Run the following command in your terminal, ensuring you are logged into Vault:

```bash
# For Production environment
vault write -f auth/approle/role/n8n-prod-role/secret-id
```

This command will output a `secret_id`. **Copy this value immediately.**

### Step 3: Configure N8N Environment Variables

When starting your n8n Docker container, you must provide the credentials via environment variables.

Here is an example for a `docker-compose.yml` file:

```yaml
version: '3.8'

services:
  n8n:
    image: n8nio/n8n
    restart: always
    ports:
      - "5678:5678"
    environment:
      # --- Vault AppRole Credentials ---
      N8N_CREDENTIALS_VAULT_AUTH_TYPE: 'appRole'
      N8N_CREDENTIALS_VAULT_URL: '${VAULT_ADDR}' # e.g., http://127.0.0.1:8200
      N8N_CREDENTIALS_VAULT_ROLE_ID: '${VAULT_ROLE_ID}' # RoleID from Step 1
      N8N_CREDENTIALS_VAULT_SECRET_ID: '${VAULT_SECRET_ID}' # SecretID from Step 2

      # --- Vault Path Configuration ---
      # Tells n8n where to look for secrets.
      # The `{{client}}` and `{{integration}}` parts are placeholders
      # that n8n will fill in dynamically.
      N8N_CREDENTIALS_VAULT_PATH_PATTERN: 'kv/data/{{client}}/{{integration}}'

      # Other n8n configurations...
      GENERIC_TIMEZONE: 'Europe/Berlin'
```

### Summary

By following these steps, your n8n instance will start, authenticate with Vault using its assigned `RoleID` and `SecretID`, receive a temporary token, and use that token to securely fetch the credentials it needs on demand.
